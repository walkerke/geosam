---
title: "Getting started with geosam"
format: html
editor: visual
eval: false
---

geosam provides an R interface to Meta's Segment Anything Model 3 (SAM3) for detecting objects in satellite imagery and photos. Unlike traditional computer vision approaches, SAM3 lets you describe what you're looking for in plain text—no training data or model fine-tuning required.

The package is inspired by Python's segment-geospatial package, which offers similar functionality for R users.  This package offers an R-native API to R users, linking to packages such as terra for spatial workflows and magick for image manipulation.  It also includes tools for interactive viewing and extraction with the mapgl R package.  

### Installation

Getting set up with geosam takes a few steps.  First, install the package from GitHub:

``` r
remotes::install_github("walkerke/geosam")
```

Or: 

```r
pak::pak("walkerke/geosam")
```

Once installed, load the package then set up a SAM3 Python environment with `geosam_install()`.  By default, if run with no arguments, `geosam_install()` will use __uv__ for the Python environment.  

``` r
library(geosam)
geosam_install()
```

This creates a dedicated uv environment with PyTorch and HuggingFace transformers.

If you prefer to use __venv__ or __conda__ for Python environment management, you can supply the appropriate argument to `geosam_install()`: 

```r
geosam_install(method = "conda") # or method = "virtualenv"
```

This will set up a Python environment named `geosam` unless you supply an alternative name to `envname`.

#### Windows prerequisites

On Windows, you'll need a couple of additional tools:

- **Git**: Required to install SAM3 from GitHub. Download from [git-scm.com](https://git-scm.com/download/win) and install with default settings.
- **Rtools**: Required to compile some R package dependencies. Download from [CRAN](https://cran.r-project.org/bin/windows/Rtools/).

After installing these, restart your R session before running `geosam_install()`.

### Authentication

geosam uses Meta's SAM3 model hosted on HuggingFace, which requires authentication. You'll need to complete two steps: request access to the model, and set up your access token.

#### Requesting SAM3 access

First, visit the [SAM3 model page on HuggingFace](https://huggingface.co/facebook/sam3) and click "Request access." You'll need a free HuggingFace account. Access is typically granted quickly, but may take a few hours.

#### Setting up your access token

Once you have access, you'll need a User Access Token. From your HuggingFace account, go to **Settings > Access Tokens** and create a new token. A "read" token is sufficient for geosam since we're only downloading model weights—and read tokens are safer in case your token is accidentally exposed.

The easiest way to authenticate is to save the token on your machine using the HuggingFace CLI. From your terminal:

```bash
huggingface-cli login
```

This saves your token to `~/.cache/huggingface/token`, where geosam will find it automatically.

Alternatively, you can set the token as an environment variable in R. For persistent use across sessions, add it to your `.Renviron` file:

``` r
# Open your .Renviron file
usethis::edit_r_environ()

# Add this line:
# HF_TOKEN=hf_xxxxx
```

Or set it for a single session:

``` r
Sys.setenv(HF_TOKEN = "hf_xxxxx")
```

#### Imagery API keys

For satellite imagery, geosam supports three providers. Mapbox offers high-quality imagery but requires an API key:

``` r
Sys.setenv(MAPBOX_PUBLIC_TOKEN = "pk.xxxxx")
```

Esri World Imagery works without any API key, making it a good option for getting started. MapTiler is also supported with the `MAPTILER_API_KEY` environment variable.

### Check your setup

Verify everything is working:

``` r
geosam_status()
```

### Your first detection

Let's detect swimming pools in a neighborhood:

``` r
library(geosam)

pools <- sam_detect(
  bbox = c(-118.42, 34.08, -118.40, 34.10),
  text = "swimming pool",
  source = "mapbox",
  zoom = 18
)

pools
```

View results interactively:

``` r
sam_view(pools)
```

Extract as sf polygons for analysis:

``` r
pools_sf <- sam_as_sf(pools)
```

### Next steps

- [Satellite Imagery Detection](satellite-detection.html) - Full guide to geospatial workflows
- [Regular Image Detection](image-detection.html) - Working with photos and screenshots
- [Interactive Workflows](interactive.html) - Using the explore and view interfaces
